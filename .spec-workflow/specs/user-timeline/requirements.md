# Requirements Document: User Timeline

## Introduction

ユーザーごとのタイムライン機能を実装し、個人の読書記録を `/{username}` パスで閲覧できるようにする。現在の単一ユーザー想定から、複数ユーザーが自分の読書記録を持てる形に拡張する。また、本の登録時に自動で「登録ログ」を作成し、ログのない本もタイムラインに表示されるようにする。

## Alignment with Product Vision

この機能は product.md に記載されている以下の目標に直接貢献する:
- **複数ユーザー対応**: Future Vision に記載の「ユーザー認証と個人データの分離」の基盤
- **読書習慣の継続サポート**: 本を登録するだけでタイムラインに表示されることで、記録のハードルを下げる
- **データの永続性**: ユーザーごとの読書記録を安全に保存し、いつでもアクセス可能にする

## Requirements

### REQ-1: ユーザータイムラインの表示

**User Story:** ユーザーとして、自分のタイムラインを `/{username}` で確認したい。自分の読書記録だけが表示されることで、パーソナライズされた読書体験を得られる。

#### Acceptance Criteria

1. WHEN ユーザーが `/{username}` にアクセスする THEN システムは該当ユーザーのタイムラインを表示する SHALL
2. IF ユーザーが存在しない THEN システムは 404 エラーページを表示する SHALL
3. WHEN タイムラインを表示する THEN ログは時系列（新しい順）で表示される SHALL
4. WHEN 同じ本に対して複数のログが連続する THEN 本の表紙と線・点でグループ化して表示する SHALL
5. WHEN ユーザータイムラインを表示する THEN ホームページ（`/home`）と同じ要素・レイアウトを使用する SHALL
6. WHEN ユーザータイムラインを表示する THEN ユーザー情報、アクションボタン、タブナビゲーション（タイムライン/本棚）を表示する SHALL
7. WHEN 他人のタイムラインを表示する THEN 「ログを追加」ボタンは表示しない SHALL（閲覧専用）

### REQ-2: ログとユーザーの紐づけ

**User Story:** ユーザーとして、自分が記録したログが自分のアカウントに紐づいていてほしい。他のユーザーのログと混在しないことで、自分の読書記録を正確に管理できる。

#### Acceptance Criteria

1. WHEN ログを作成する THEN ログは現在のログインユーザーに紐づけられる SHALL
2. WHEN タイムラインを表示する THEN 該当ユーザーのログのみがフィルタされて表示される SHALL
3. IF 認証されていないユーザーがログを作成しようとする THEN システムはログインを促す SHALL

### REQ-3: ログの編集機能

**User Story:** ユーザーとして、過去に記録したログを編集したい。誤字の修正や内容の追記ができることで、より正確な読書記録を維持できる。

#### Acceptance Criteria

1. WHEN ユーザーが自分のログの編集ボタンをクリックする THEN 編集モードに切り替わる SHALL
2. WHEN ログを編集して保存する THEN 変更内容がデータベースに反映される SHALL
3. WHEN タイムラインを表示する THEN 編集ボタンはログを作成したユーザー本人にのみ表示する SHALL（他ユーザーには編集導線を表示しない）
4. WHEN ログを編集する THEN ログ種別（メモ/引用）、内容、ページ番号を変更できる SHALL
5. IF API経由で他人のログを編集しようとする THEN システムは 403 Forbidden を返す SHALL（セキュリティ対策）

### REQ-4: 登録ログの自動作成

**User Story:** ユーザーとして、本を登録したらすぐにタイムラインに表示されてほしい。まだ読み始めていない本も含めて、登録した本を一覧できることで、読書計画を立てやすくなる。

#### Acceptance Criteria

1. WHEN ユーザーが本を登録する THEN システムは自動的に「登録ログ」を1件作成する SHALL
2. WHEN 登録ログを作成する THEN ログ内容にはじまりを意味する絵文字（例: 📖）を設定する SHALL
3. WHEN 登録ログを作成する THEN ログ種別は「registration」（登録）として記録する SHALL
4. WHEN 登録ログを作成する THEN ログの日時は本の登録日時と同一にする SHALL

### REQ-5: 登録ログのタイムライン表示ルール

**User Story:** ユーザーとして、タイムラインではメモや引用など自分が書いたログだけを見たい。「登録しました」という自動生成のログは表示せず、本の情報だけを見せてほしい。

#### Acceptance Criteria

1. WHEN タイムラインを表示する THEN 登録ログ（log_type: registration）は常に非表示とする SHALL
2. WHEN 登録ログのみの本がある THEN タイムラインは本の表紙と基本情報（タイトル、著者）のみを表示する SHALL
3. WHEN 本にメモや引用のログがある THEN それらのログのみを表示し、登録ログは表示しない SHALL
4. WHEN ログを取得する THEN 登録ログはデータとしては存在するが、UI表示時にフィルタする SHALL（ロジック上は存在）

### REQ-6: ホームページの分離（別仕様として定義）

**User Story:** サービス運営者として、ホームページ（`/`）はサービス説明の画面としたい。誰かのタイムラインではなく、サービスの紹介やログインへの導線を表示する。

#### Acceptance Criteria

1. WHEN ユーザーが `/` にアクセスする THEN サービス説明画面が表示される SHALL（別仕様で詳細定義）
2. WHEN サービス説明画面を表示する THEN ログインボタン/ユーザー登録への導線が表示される SHALL（別仕様で詳細定義）

**Note:** ホームページの詳細仕様は別の spec（`homepage-landing`）で定義する。本仕様では /{username} へのルーティングが `/` と競合しないことのみを保証する。

## Non-Functional Requirements

### Code Architecture and Modularity
- **Single Responsibility Principle**: ユーザータイムライン関連のロジックは専用のフック（`useUserTimeline`）に分離
- **Modular Design**: 登録ログの作成ロジックは本の登録APIに統合しつつ、ログ作成ロジックを再利用
- **Dependency Management**: 既存の `useTimeline` フックを拡張し、ユーザーフィルタ機能を追加
- **Clear Interfaces**: ユーザー識別子（username）をパスパラメータとして明確に定義

### Performance
- タイムラインの初回読み込みは 1 秒以内
- ログの編集・保存は 500ms 以内にレスポンス
- ページネーションまたは無限スクロールで大量のログに対応（将来拡張）

### Security
- ユーザーは自分のログのみ編集可能（認可チェック）
- 他ユーザーのタイムラインは閲覧のみ可能
- XSS 対策として引用・メモ内容は適切にエスケープ

### Reliability
- ログの作成・編集は失敗時にエラーメッセージを表示
- 登録ログの自動作成が失敗しても本の登録自体は成功させる（ログは後から手動作成可能）

### Usability
- 既存のタイムライン操作（ログ追加、本の詳細表示）は維持
- ログの編集は直感的な UI で提供（インライン編集またはモーダル）
- 登録ログのみの本は視覚的に区別可能（読書開始前であることが分かる）

## Glossary

- **タイムライン**: ユーザーの読書ログを時系列で表示する画面
- **ログ**: 読書中に記録するメモや引用の1エントリ
- **登録ログ**: 本の登録時に自動作成される特殊なログ。ログ種別は「registration」
- **グループ表示**: 同じ本に対する複数のログを、本の表紙と線・点でまとめて表示するUI
- **username**: ユーザーを一意に識別する文字列（URL パスに使用）
