# Requirements Document

## Introduction

本の検索体験を向上させる機能拡張。現状の `/books/new` ページでは、タイトルを正しく入力しても関係ない結果が上位に表示されてしまい、目的の本を見つけにくい問題がある。

**解決するアプローチ:**
1. ページネーション機能を追加し、より多くの検索結果を探索可能にする
2. クライアントサイドでタイトル・著者名の一致度によるソートを行い、検索語に近い結果を優先表示する

## Alignment with Product Vision

本機能は product.md の以下の項目に合致する:

- **Key Features #3**: 「本の管理: 本の登録・編集・削除。国立国会図書館 API との連携で書誌情報を自動取得」の改善
- **Future Vision**: 「本の登録の簡便化: 検索機能の強化」として明記されている
- **Product Principles #1**: 「シンプルさ優先: 機能を絞り、直感的な UI を維持する」に従い、複雑な検索オプションではなく、自動的に最適な結果を表示する方針を採用

## Requirements

### Requirement 1: ページネーション機能

**User Story:** ユーザーとして、検索結果を10件以上見たいので、「もっと見る」ボタンで追加の結果を読み込めるようにしたい

#### Acceptance Criteria

1. WHEN 検索結果が表示されている THEN システム SHALL 検索結果の下部に「もっと見る」ボタンを表示する
2. WHEN ユーザーが「もっと見る」ボタンをクリック THEN システム SHALL 次の検索結果（次の30件）を取得して既存の結果に追加表示する
3. WHEN 追加の検索結果を読み込み中 THEN システム SHALL 「もっと見る」ボタンにローディング状態を表示する
4. IF 検索結果の総数が現在表示されている件数以下 THEN システム SHALL 「もっと見る」ボタンを非表示にする
5. IF NDL API の制限（500件）に達した THEN システム SHALL 「もっと見る」ボタンを非表示にする

### Requirement 2: 検索結果の一致度ソート

**User Story:** ユーザーとして、入力したタイトルに最も近い本を素早く見つけたいので、検索結果をタイトルの一致度順に並び替えてほしい

#### Acceptance Criteria

1. WHEN 検索結果が取得された THEN システム SHALL 結果をタイトル一致度でソートして表示する
2. WHEN ソートする THEN システム SHALL 以下の優先順位で並び替える:
   - 完全一致（タイトルが検索語と完全に一致）
   - 前方一致（タイトルが検索語で始まる）
   - 部分一致（タイトルに検索語が含まれる）
   - その他
3. WHEN 同じ一致度レベルの結果がある THEN システム SHALL 著者名の一致度を副次的なソート条件として使用する
4. WHEN 追加の検索結果を読み込んだ THEN システム SHALL 新しい結果も含めて全体を再ソートする

### Requirement 3: 取得件数の最適化

**User Story:** ユーザーとして、より精度の高い検索結果を得たいので、十分な件数の結果から最適なものを表示してほしい

#### Acceptance Criteria

1. WHEN 検索が実行された THEN システム SHALL 初回は30件の結果を NDL API から取得する
2. WHEN 結果を表示する THEN システム SHALL ソート後の上位結果を画面に表示する
3. IF 検索語が変更された THEN システム SHALL 前回の検索結果をクリアして新規検索を実行する

## Non-Functional Requirements

### Code Architecture and Modularity
- **Single Responsibility Principle**: ソートロジックは独立したユーティリティ関数として実装
- **Modular Design**: ページネーション状態管理は useBookSearch フック内に統合
- **Dependency Management**: 既存の NDL API クライアント、検索フックを拡張する形で実装
- **Clear Interfaces**: ソート関数は純粋関数として実装し、テスト容易性を確保

### Performance
- API 呼び出しは現状のデバウンス（500ms）を維持
- ソート処理はクライアントサイドで実行し、追加のサーバー負荷を発生させない
- 「もっと見る」の追加読み込みは既存結果を保持し、差分のみ追加

### Security
- 既存の入力値バリデーション（Zod）を継続使用
- NDL API への通信は現状の実装を維持

### Reliability
- NDL API の 500 件制限を超えないよう制御
- API エラー時は既存のエラーハンドリングを継続使用

### Usability
- 「もっと見る」ボタンはローディング状態を視覚的に表示
- 検索結果の表示順序が変わっても、ユーザーが選択した本は正しく選択できる
- 検索中のスピナー表示は現状を維持
