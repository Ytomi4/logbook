# Requirements Document: Unified Log

## Introduction

現在のログシステムでは「メモ」と「引用」をログの種類として区別しているが、実際の使用において引用とメモを一緒に記録したい場面が多いことが判明した。本機能は、ログの種類区分を廃止し、1つのログ内で任意の段落を「引用箇所」としてマークできるリッチテキスト形式に変更する。

## Scope

本機能は以下の画面に適用する：

- **タイムラインビュー** (`/timeline`): インラインログフォーム
- **本の詳細ページ** (`/books/:id`): ログ入力フォーム

両画面で統一されたログ入力体験を提供する。

## Alignment with Product Vision

- **「どう読んだか」を残す**: 引用とメモを混在させることで、より自然な読書体験の記録が可能になる
- **シンプルさ優先**: メモ/引用の選択ボタンを廃止し、UIを簡素化する
- **高速な操作**: テキスト選択→引用ボタンの直感的な操作で、思考を中断せずに記録できる
- **読書中に使える**: ボーダーレスなフォームデザインで、読書の流れを妨げない

## Requirements

### Requirement 1: ログタイプの統合

**User Story:** ユーザーとして、引用とメモを同じログ内に混在させて記録したい。それにより、引用した文章に対するコメントや感想を自然な形で残せる。

#### Acceptance Criteria

1. WHEN ログを作成する THEN システム SHALL ログタイプの区別なく単一のログとして保存する
2. IF 既存のログが `memo` または `quote` タイプである THEN システム SHALL 引き続き正しく表示する（後方互換性）
3. WHEN 新規ログを作成する THEN システム SHALL ログタイプとして `note` を使用する

### Requirement 2: 段落単位の引用マーク

**User Story:** ユーザーとして、ログ内の特定の段落を引用箇所として設定したい。それにより、本からの引用と自分のメモを視覚的に区別できる。

#### Acceptance Criteria

1. WHEN ログ内に引用箇所としてマークされた段落がある THEN システム SHALL その段落に引用スタイル（左ボーダー、イタリック）を適用して表示する
2. WHEN 複数の段落が引用としてマークされている THEN システム SHALL 各段落を個別に引用スタイルで表示する
3. IF 引用マークのない段落がある THEN システム SHALL 通常のテキストスタイルで表示する

### Requirement 3: リッチテキスト入力フォーム

**User Story:** ユーザーとして、入力フォーム内でも引用箇所を視覚的に確認しながら編集したい。それにより、記録内容の構成を把握しやすくなる。

#### Acceptance Criteria

1. WHEN 入力フォームで編集中 THEN システム SHALL 引用箇所を引用スタイル（左ボーダー）で表示する
2. WHEN 入力フォームでテキストを選択し引用ボタンを押す THEN システム SHALL 選択されたテキストを含む段落を引用箇所として設定する
3. WHEN 引用箇所として設定された段落を再度選択し引用ボタンを押す THEN システム SHALL その段落の引用設定を解除する
4. IF 入力フォームが空の状態である THEN システム SHALL プレースホルダーテキストを表示する

### Requirement 4: 引用ボタンUI

**User Story:** ユーザーとして、テキストを選択して引用ボタンを押すだけで引用箇所を設定したい。それにより、素早く直感的に操作できる。

#### Acceptance Criteria

1. WHEN 入力フォームが表示される THEN システム SHALL フォーム下部に引用ボタン（アイコン）を表示する
2. WHEN 入力フォームが空の状態で引用ボタンを押す THEN システム SHALL 引用スタイル（左ボーダー）を表示し、そのまま引用内容を入力できる状態にする
3. WHEN テキストが入力されている状態で、フォーム内にカーソルがあり、テキストを選択せずに引用ボタンを押す THEN システム SHALL カーソルのある段落を引用箇所として設定する
4. WHEN テキストが入力されている状態で、フォーム内にカーソルがなく、引用ボタンを押す THEN システム SHALL 入力済みテキスト全体を引用箇所として設定する
5. WHEN テキストを選択して引用ボタンを押す THEN システム SHALL 選択範囲を含む段落全体を引用箇所として設定する
6. WHEN キーボードショートカット（`Ctrl/Cmd + Shift + Q`）を押す THEN システム SHALL 引用ボタンを押したときと同じ動作をする
7. WHEN デスクトップ環境で引用ボタンが表示される THEN システム SHALL ボタンの隣にキーボードショートカットの案内を表示する
8. WHEN モバイル環境で引用ボタンが表示される THEN システム SHALL キーボードショートカットの案内を表示しない

### Requirement 5: ボーダーレスフォームデザイン

**User Story:** ユーザーとして、入力フォームが周囲に溶け込んだ見た目であってほしい。それにより、ページ全体の一体感が保たれる。

#### Acceptance Criteria

1. WHEN 入力フォームを表示する THEN システム SHALL アウトライン（ボーダー）のないデザインで表示する
2. IF 入力エラーが発生した THEN システム SHALL エラーメッセージを表示するが、フォーム自体のスタイルは維持する

### Requirement 6: 既存UIコンポーネントの削除

**User Story:** ユーザーとして、メモと引用を選択するボタンが不要になった。それにより、UIがシンプルになる。

#### Acceptance Criteria

1. WHEN 入力フォームを表示する THEN システム SHALL LogTypeSelector（メモ/引用切り替えボタン）を表示しない
2. WHEN ログを編集する THEN システム SHALL ログタイプ切り替えUIを表示しない

## Non-Functional Requirements

### Code Architecture and Modularity

- **Single Responsibility Principle**: リッチテキスト編集ロジックは専用のフック（`useRichTextEditor`など）に分離する
- **Modular Design**: 引用スタイル表示コンポーネントは再利用可能な形で設計する
- **Dependency Management**: 既存の `LogForm` コンポーネントを段階的に置き換え、影響範囲を最小化する
- **Clear Interfaces**: ログのコンテンツ形式（引用マーク情報を含む）を明確に定義する

### Performance

- リッチテキスト編集は軽量に実装し、入力遅延を感じさせない（50ms以内のレスポンス）
- 大量のテキスト（10,000文字）でもスムーズに編集できる

### Security

- ユーザー入力のサニタイズを継続し、XSS攻撃を防止する
- 引用マーク情報は信頼できる形式で保存・取得する

### Reliability

- 既存ログデータとの後方互換性を維持する
- オフライン時でも入力内容を失わない（ブラウザのローカルストレージ活用は将来検討）

### Usability

- 引用ボタンはアイコンで表示し、ツールチップで機能を説明する
- キーボードショートカット（`Ctrl/Cmd + Shift + Q`）での引用設定を実装する
- デスクトップではショートカット案内を表示、モバイルでは非表示
- モバイルでも使いやすいタッチターゲットサイズを確保する

## Data Model Considerations

現在の `content` フィールド（プレーンテキスト）から、引用情報を含む構造化データへの移行が必要：

**Option A**: Markdown風のマーカー
```
> 引用テキスト
通常のメモテキスト
> 別の引用
```

**Option B**: JSON構造
```json
{
  "blocks": [
    { "type": "quote", "text": "引用テキスト" },
    { "type": "text", "text": "通常のメモテキスト" },
    { "type": "quote", "text": "別の引用" }
  ]
}
```

**Option C**: HTML/リッチテキスト形式
```html
<blockquote>引用テキスト</blockquote>
<p>通常のメモテキスト</p>
```

→ 設計フェーズで最適なアプローチを決定する
