# Requirements Document: User Profile Setup

## Introduction

アカウント作成後にサービス専用のユーザー名とアイコン画像を登録できる機能。Google 認証で取得した情報とは別に、このサービス用のプロフィールを設定できるようにする。

ユーザー名はシェア用タイムラインページの URL（例: `/{username}`）に使用するため、ユニークかつ英数字のみに制限する。システムの予約語（既存ルートと衝突する語）はユーザー名として使用できない。

## Alignment with Product Vision

product.md の「Future Vision」で言及されている「複数ユーザー対応」の基盤となる機能。また「Sharing Capabilities」（共有機能）を実現するための前提条件として、ユーザーを識別可能な公開 URL が必要であり、本機能がそれを可能にする。

## User Flows

### Flow 1: 初回ユーザー登録フロー

```
[未ログイン状態]
    │
    ▼
┌─────────────────────────────────┐
│ ヘッダー右上「はじめる」ボタン    │
└─────────────────────────────────┘
    │ クリック
    ▼
┌─────────────────────────────────┐
│ 登録画面 (/enter)               │
│ ・Logbook アイコン・ロゴ        │
│ ・サービス説明文                │
│ ・「Googleアカウントでログイン」 │
└─────────────────────────────────┘
    │ Google認証
    ▼
┌─────────────────────────────────┐
│ ハンドルネーム設定画面           │
│ ・タイトル: アカウントを作成します│
│ ・説明: ハンドルネームを決めましょう│
│ ・ユーザー名入力テキストボックス │
│ ・バリデーションエラー表示      │
│ ・「これで始める」ボタン        │
└─────────────────────────────────┘
    │ ユーザー名登録完了
    ▼
┌─────────────────────────────────┐
│ 自分のタイムラインページ         │
│ /{username}                     │
└─────────────────────────────────┘
```

### Flow 2: アイコン変更フロー（登録後）

```
[ログイン済み状態]
    │
    ▼
┌─────────────────────────────────┐
│ ヘッダーのユーザーアイコン       │
└─────────────────────────────────┘
    │ クリック
    ▼
┌─────────────────────────────────┐
│ アカウント設定画面 (/settings)   │
│ ・現在のアイコン表示            │
│ ・アイコン変更ボタン            │
│ ・ユーザー名変更                │
└─────────────────────────────────┘
    │ 画像アップロード
    ▼
┌─────────────────────────────────┐
│ 変更完了                        │
└─────────────────────────────────┘
```

## Requirements

### REQ-1: ユーザー名の登録

**User Story:** ユーザーとして、自分専用のユーザー名を登録したい。タイムラインを共有する際の URL に使いたいから。

#### Acceptance Criteria

1. WHEN ユーザーがユーザー名を入力 THEN システム SHALL 英数字（a-z, A-Z, 0-9）およびアンダースコア（_）のみを受け付ける
2. WHEN ユーザー名が 3文字未満または 20文字超過 THEN システム SHALL エラーメッセージを表示し登録を拒否する
3. WHEN 入力されたユーザー名が既に他のユーザーに使用されている THEN システム SHALL 「このユーザー名は既に使用されています」と表示し登録を拒否する
4. WHEN 有効なユーザー名が入力される THEN システム SHALL リアルタイムでユーザー名の利用可否をチェックする
5. WHEN ユーザー名の登録が完了 THEN システム SHALL ユーザーのタイムラインを `/{username}` で公開可能にする
6. IF ユーザー名が未設定 THEN システム SHALL タイムライン共有 URL を生成しない
7. WHEN 入力されたユーザー名が予約語に該当する THEN システム SHALL 「このユーザー名は使用できません」と表示し登録を拒否する

### REQ-2: アイコン画像の登録

**User Story:** ユーザーとして、サービス用のアイコン画像を設定したい。Google アカウントの画像とは別の画像を使いたいから。

#### Acceptance Criteria

1. WHEN ユーザーがアイコン画像をアップロード THEN システム SHALL 画像を受け付け保存する
2. WHEN アップロードされたファイルが画像形式（JPEG, PNG, GIF, WebP）でない THEN システム SHALL エラーメッセージを表示し登録を拒否する
3. WHEN アップロードされた画像のファイルサイズが 2MB を超過 THEN システム SHALL エラーメッセージを表示し登録を拒否する
4. WHEN アイコン画像が設定されていない THEN システム SHALL Google アカウントの画像を表示する
5. WHEN アイコン画像の登録が完了 THEN システム SHALL 即座に UI 全体で新しいアイコンを反映する

### REQ-3: 登録画面（/enter）

**User Story:** 新規ユーザーとして、サービスの魅力を理解してから登録を開始したい。安心してアカウントを作成したいから。

#### Acceptance Criteria

1. WHEN 未ログインユーザーが `/enter` にアクセス THEN システム SHALL Logbook のアイコン、ロゴ、サービス説明文を表示する
2. WHEN 登録画面を表示 THEN システム SHALL 「Google アカウントでログイン」ボタンを表示する
3. WHEN 「Google アカウントでログイン」ボタンをクリック THEN システム SHALL Google OAuth 認証フローを開始する
4. WHEN 未ログインユーザーがヘッダーを見る THEN システム SHALL 右上に「はじめる」ボタンを表示する
5. WHEN 「はじめる」ボタンをクリック THEN システム SHALL `/enter` ページに遷移する

### REQ-4: ハンドルネーム設定画面

**User Story:** 新規ユーザーとして、Google 認証後にすぐハンドルネームを設定したい。自分のタイムライン URL を決めたいから。

#### Acceptance Criteria

1. WHEN Google 認証が完了しユーザー名が未設定 THEN システム SHALL ハンドルネーム設定画面に遷移する
2. WHEN ハンドルネーム設定画面を表示 THEN システム SHALL 「アカウントを作成します」というタイトルを表示する
3. WHEN ハンドルネーム設定画面を表示 THEN システム SHALL 「ハンドルネームを決めましょう」という説明とテキストボックスを表示する
4. WHEN 使えないハンドルネームを入力 THEN システム SHALL 使えない理由を表示する
5. WHEN 有効なハンドルネームを入力 THEN システム SHALL 「これで始める」ボタンを有効化する
6. WHEN 「これで始める」ボタンをクリック THEN システム SHALL ユーザー名を登録し、自分のタイムラインページ `/{username}` に遷移する
7. IF ユーザー名が未設定のままアプリ内を移動 THEN システム SHALL ハンドルネーム設定画面にリダイレクトする

### REQ-5: アカウント設定画面（/settings）

**User Story:** ログイン済みユーザーとして、ユーザー名とアイコンを変更したい。後から設定を調整したいから。

#### Acceptance Criteria

1. WHEN ログイン済みユーザーがヘッダーのユーザーアイコンをクリック THEN システム SHALL アカウント設定画面へのリンクを表示する
2. WHEN アカウント設定画面を開く THEN システム SHALL 現在のユーザー名とアイコン画像を表示する
3. WHEN ユーザーがアイコン画像を変更 THEN システム SHALL 新しい画像をアップロードし保存する
4. WHEN ユーザーがユーザー名を変更 THEN システム SHALL 新しいユーザー名の一意性を検証し保存する
5. WHEN 変更を保存 THEN システム SHALL 変更が成功したことを通知する

### REQ-6: ユーザー名の一意性検証

**User Story:** システムとして、ユーザー名の重複を防ぎたい。各ユーザーが一意に識別可能であるため。

#### Acceptance Criteria

1. WHEN ユーザー名を登録しようとする THEN システム SHALL データベースレベルで一意性を強制する
2. WHEN 同時に同じユーザー名が登録される THEN システム SHALL 一方の登録を拒否する（race condition 対策）
3. WHEN ユーザー名を変更する THEN システム SHALL 新しいユーザー名の一意性を再検証する

### REQ-7: ユーザー名によるタイムラインアクセス

**User Story:** 訪問者として、ユーザー名を使ってタイムラインにアクセスしたい。共有されたリンクから直接閲覧したいから。

#### Acceptance Criteria

1. WHEN `/{username}` にアクセス THEN システム SHALL 該当ユーザーの公開タイムラインを表示する
2. WHEN 存在しないユーザー名でアクセス THEN システム SHALL 404 エラーページを表示する
3. WHEN ユーザー名が変更された後に古い URL でアクセス THEN システム SHALL 404 エラーを表示する（リダイレクトしない）

## Non-Functional Requirements

### Code Architecture and Modularity

- **Single Responsibility Principle**: プロフィール関連のロジックは専用のサービス・フックに分離する
- **Modular Design**: 画像アップロード機能は再利用可能なコンポーネントとして設計する
- **Dependency Management**: 既存の認証フロー（useAuth）を拡張する形で実装する
- **Clear Interfaces**: プロフィール API は RESTful なエンドポイントとして設計する

### Performance

- ユーザー名の利用可否チェックはデバウンス（300ms）を適用し、API 呼び出しを最適化する
- 画像アップロードは非同期で行い、UI をブロックしない
- 画像は適切なサイズにリサイズしてから保存する（サーバーサイドまたはクライアントサイド）

### Security

- ユーザー名の入力値はサニタイズし、XSS 攻撃を防ぐ
- 画像アップロードはファイルタイプを厳格に検証し、悪意のあるファイルを拒否する
- プロフィール更新 API は認証済みユーザーのみアクセス可能とする
- 自分以外のプロフィールは編集不可とする

### Reliability

- プロフィール更新失敗時は適切なエラーメッセージを表示し、データの整合性を維持する
- 画像アップロード失敗時もプロフィールの他の変更は保存可能とする

### Usability

- プロフィール設定画面は直感的で、入力項目は最小限にする
- エラーメッセージは具体的で、修正方法が分かるようにする
- 画像プレビューをアップロード前に表示する
- ユーザー名入力時に利用可否をリアルタイムフィードバックで表示する
