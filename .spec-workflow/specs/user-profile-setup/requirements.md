# Requirements Document: User Profile Setup

## Implementation Status

**Status**: 仕様修正中（フィードバック反映）
**Last Updated**: 2025-12-21

### 完了した機能
- ✅ ハンドルネームの登録・変更
- ✅ アバター画像のアップロード・変更
- ✅ 登録画面（/enter）
- ✅ ハンドルネーム設定画面（/setup）
- ✅ アカウント設定画面（/settings）
- ✅ 公開タイムライン（/:username）
- ✅ ハンドルネームの一意性検証
- ✅ リアルタイムバリデーション

### 未実装・今後の課題
- ⚠️ 画像のリサイズ処理（現在は元サイズのまま保存）
- ⚠️ 古いアバター画像の削除（R2に残存）

### v1.1 修正（2025-12-21 フィードバック対応）
- 🔧 ヘッダーロゴクリック時はホームページに遷移（/setupリダイレクトは初回登録時のみ）
- 🔧 サイト内表示は「ハンドルネーム」に統一（Google名は非表示）
- 🔧 公開タイムラインでアバター画像を正しく表示
- 🔧 アカウント設定内の表記重複を解消

## Introduction

アカウント作成後にサービス専用のハンドルネームとアイコン画像を登録できる機能。Google 認証で取得した情報（Google名やプロフィール画像）とは別に、このサービス用のプロフィールを設定できるようにする。

**用語の定義:**
- **ハンドルネーム**: サービス内でユーザーを識別する表示名。UI上では「ハンドルネーム」と呼ぶ
- **username**: ハンドルネームの内部的な識別子。URL（例: `/{username}`）に使用
- **Google名**: Google アカウントに紐づく本名。**サービス内では一切表示しない**

ハンドルネームはシェア用タイムラインページの URL（例: `/{username}`）に使用するため、ユニークかつ英数字のみに制限する。システムの予約語（既存ルートと衝突する語）はハンドルネームとして使用できない。

## Alignment with Product Vision

product.md の「Future Vision」で言及されている「複数ユーザー対応」の基盤となる機能。また「Sharing Capabilities」（共有機能）を実現するための前提条件として、ユーザーを識別可能な公開 URL が必要であり、本機能がそれを可能にする。

## User Flows

### Flow 1: 初回ユーザー登録フロー

```
[未ログイン状態]
    │
    ▼
┌─────────────────────────────────┐
│ ヘッダー右上「はじめる」ボタン    │
└─────────────────────────────────┘
    │ クリック
    ▼
┌─────────────────────────────────┐
│ 登録画面 (/enter)               │
│ ・Logbook アイコン・ロゴ        │
│ ・サービス説明文                │
│ ・「Googleアカウントでログイン」 │
└─────────────────────────────────┘
    │ Google認証
    ▼
┌─────────────────────────────────┐
│ ハンドルネーム設定画面           │
│ ・タイトル: アカウントを作成します│
│ ・説明: ハンドルネームを決めましょう│
│ ・ユーザー名入力テキストボックス │
│ ・バリデーションエラー表示      │
│ ・「これで始める」ボタン        │
└─────────────────────────────────┘
    │ ユーザー名登録完了
    ▼
┌─────────────────────────────────┐
│ 自分のタイムラインページ         │
│ /{username}                     │
└─────────────────────────────────┘
```

### Flow 2: アイコン変更フロー（登録後）

```
[ログイン済み状態]
    │
    ▼
┌─────────────────────────────────┐
│ ヘッダーのユーザーアイコン       │
└─────────────────────────────────┘
    │ クリック
    ▼
┌─────────────────────────────────┐
│ アカウント設定画面 (/settings)   │
│ ・現在のアイコン表示            │
│ ・アイコン変更ボタン            │
│ ・ハンドルネーム変更            │
└─────────────────────────────────┘
    │ 画像アップロード
    ▼
┌─────────────────────────────────┐
│ 変更完了                        │
└─────────────────────────────────┘
```

## Requirements

### REQ-1: ハンドルネームの登録

**User Story:** ユーザーとして、自分専用のハンドルネームを登録したい。タイムラインを共有する際の URL に使いたいから。

#### Acceptance Criteria

1. WHEN ユーザーがハンドルネームを入力 THEN システム SHALL 英数字（a-z, A-Z, 0-9）およびアンダースコア（_）のみを受け付ける
2. WHEN ハンドルネームが 3文字未満または 20文字超過 THEN システム SHALL エラーメッセージを表示し登録を拒否する
3. WHEN 入力されたハンドルネームが既に他のユーザーに使用されている THEN システム SHALL 「このハンドルネームは既に使用されています」と表示し登録を拒否する
4. WHEN 有効なハンドルネームが入力される THEN システム SHALL リアルタイムでハンドルネームの利用可否をチェックする
5. WHEN ハンドルネームの登録が完了 THEN システム SHALL ユーザーのタイムラインを `/{username}` で公開可能にする
6. IF ハンドルネームが未設定 THEN システム SHALL タイムライン共有 URL を生成しない
7. WHEN 入力されたハンドルネームが予約語に該当する THEN システム SHALL 「このハンドルネームは使用できません」と表示し登録を拒否する

### REQ-2: アイコン画像の登録

**User Story:** ユーザーとして、サービス用のアイコン画像を設定したい。Google アカウントの画像とは別の画像を使いたいから。

#### Acceptance Criteria

1. WHEN ユーザーがアイコン画像をアップロード THEN システム SHALL 画像を受け付け保存する
2. WHEN アップロードされたファイルが画像形式（JPEG, PNG, GIF, WebP）でない THEN システム SHALL エラーメッセージを表示し登録を拒否する
3. WHEN アップロードされた画像のファイルサイズが 2MB を超過 THEN システム SHALL エラーメッセージを表示し登録を拒否する
4. WHEN アイコン画像が設定されていない THEN システム SHALL Google アカウントの画像を表示する
5. WHEN アイコン画像の登録が完了 THEN システム SHALL 即座に UI 全体で新しいアイコンを反映する

### REQ-3: 登録画面（/enter）

**User Story:** 新規ユーザーとして、サービスの魅力を理解してから登録を開始したい。安心してアカウントを作成したいから。

#### Acceptance Criteria

1. WHEN 未ログインユーザーが `/enter` にアクセス THEN システム SHALL Logbook のアイコン、ロゴ、サービス説明文を表示する
2. WHEN 登録画面を表示 THEN システム SHALL 「Google アカウントでログイン」ボタンを表示する
3. WHEN 「Google アカウントでログイン」ボタンをクリック THEN システム SHALL Google OAuth 認証フローを開始する
4. WHEN 未ログインユーザーがヘッダーを見る THEN システム SHALL 右上に「はじめる」ボタンを表示する
5. WHEN 「はじめる」ボタンをクリック THEN システム SHALL `/enter` ページに遷移する

### REQ-4: ハンドルネーム設定画面

**User Story:** 新規ユーザーとして、Google 認証後にすぐハンドルネームを設定したい。自分のタイムライン URL を決めたいから。

#### Acceptance Criteria

1. WHEN Google 認証が完了 THEN システム SHALL 認証コールバックで `/setup` に直接遷移する
2. WHEN ハンドルネーム設定画面を表示 THEN システム SHALL 「アカウントを作成します」というタイトルを表示する
3. WHEN ハンドルネーム設定画面を表示 THEN システム SHALL 「ハンドルネームを決めましょう」という説明とテキストボックスを表示する
4. WHEN 使えないハンドルネームを入力 THEN システム SHALL 使えない理由を表示する
5. WHEN 有効なハンドルネームを入力 THEN システム SHALL 「これで始める」ボタンを有効化する
6. WHEN 「これで始める」ボタンをクリック THEN システム SHALL ハンドルネームを登録し、自分のタイムラインページ `/{username}` に遷移する

### REQ-5: アカウント設定画面（/settings）

**User Story:** ログイン済みユーザーとして、ハンドルネームとアイコンを変更したい。後から設定を調整したいから。

#### Acceptance Criteria

1. WHEN ログイン済みユーザーがヘッダーのユーザーアイコンをクリック THEN システム SHALL アカウント設定画面へのリンクを表示する
2. WHEN アカウント設定画面を開く THEN システム SHALL 現在のハンドルネームとアイコン画像を表示する
3. WHEN ユーザーがアイコン画像を変更 THEN システム SHALL 新しい画像をアップロードし保存する
4. WHEN ユーザーがハンドルネームを変更 THEN システム SHALL 新しいハンドルネームの一意性を検証し保存する
5. WHEN 変更を保存 THEN システム SHALL 変更が成功したことを通知する
6. **WHEN ハンドルネーム設定セクションを表示 THEN システム SHALL タイトル「ハンドルネーム」のみを表示し、入力欄のラベルは省略する（重複表記を避ける）**

### REQ-6: ハンドルネームの一意性検証

**User Story:** システムとして、ハンドルネームの重複を防ぎたい。各ユーザーが一意に識別可能であるため。

#### Acceptance Criteria

1. WHEN ハンドルネームを登録しようとする THEN システム SHALL データベースレベルで一意性を強制する
2. WHEN 同時に同じハンドルネームが登録される THEN システム SHALL 一方の登録を拒否する（race condition 対策）
3. WHEN ハンドルネームを変更する THEN システム SHALL 新しいハンドルネームの一意性を再検証する

### REQ-7: ハンドルネームによるタイムラインアクセス

**User Story:** 訪問者として、ハンドルネームを使ってタイムラインにアクセスしたい。共有されたリンクから直接閲覧したいから。

#### Acceptance Criteria

1. WHEN `/{username}` にアクセス THEN システム SHALL 該当ユーザーの公開タイムラインを表示する
2. WHEN 存在しないハンドルネームでアクセス THEN システム SHALL 404 エラーページを表示する
3. WHEN ハンドルネームが変更された後に古い URL でアクセス THEN システム SHALL 404 エラーを表示する（リダイレクトしない）
4. **WHEN 公開タイムラインのヘッダー部分を表示 THEN システム SHALL ユーザーが登録したアバター画像を表示する（未設定時はデフォルトアイコン）**
5. **WHEN 公開タイムラインのヘッダー部分を表示 THEN システム SHALL ハンドルネームのみを表示し、Google名は表示しない**

### REQ-8: サイト内でのユーザー表示ルール

**User Story:** ユーザーとして、サービス内で自分が設定したハンドルネームで表示されたい。Google アカウントの本名はプライバシーの観点から表示したくないから。

#### Acceptance Criteria

1. WHEN ヘッダー右上にログイン済みユーザー情報を表示 THEN システム SHALL ハンドルネームを表示する（Google名は表示しない）
2. WHEN ヘッダー右上にログイン済みユーザーのアイコンを表示 THEN システム SHALL 登録されたアバター画像を表示する（未設定時はデフォルトアイコン）
3. WHEN サイト内のいずれかの場所でユーザー名を表示 THEN システム SHALL 常にハンドルネームを使用し、Google名は使用しない
4. WHEN アバター画像を表示する場所で画像が未設定 THEN システム SHALL デフォルトアイコン（イニシャルまたはプレースホルダー）を表示する（Googleアカウントの画像は使用しない）

## Non-Functional Requirements

### Code Architecture and Modularity

- **Single Responsibility Principle**: プロフィール関連のロジックは専用のサービス・フックに分離する
- **Modular Design**: 画像アップロード機能は再利用可能なコンポーネントとして設計する
- **Dependency Management**: 既存の認証フロー（useAuth）を拡張する形で実装する
- **Clear Interfaces**: プロフィール API は RESTful なエンドポイントとして設計する

### Performance

- ユーザー名の利用可否チェックはデバウンス（300ms）を適用し、API 呼び出しを最適化する
- 画像アップロードは非同期で行い、UI をブロックしない
- 画像は適切なサイズにリサイズしてから保存する（サーバーサイドまたはクライアントサイド）

### Security

- ユーザー名の入力値はサニタイズし、XSS 攻撃を防ぐ
- 画像アップロードはファイルタイプを厳格に検証し、悪意のあるファイルを拒否する
- プロフィール更新 API は認証済みユーザーのみアクセス可能とする
- 自分以外のプロフィールは編集不可とする

### Reliability

- プロフィール更新失敗時は適切なエラーメッセージを表示し、データの整合性を維持する
- 画像アップロード失敗時もプロフィールの他の変更は保存可能とする

### Usability

- プロフィール設定画面は直感的で、入力項目は最小限にする
- エラーメッセージは具体的で、修正方法が分かるようにする
- 画像プレビューをアップロード前に表示する
- ユーザー名入力時に利用可否をリアルタイムフィードバックで表示する

## User Feedback

_テスト時に発見した問題点や改善提案をここに記録する_

### Issues Found

#### 2025-12-21: v1.1 フィードバック

1. **ヘッダーロゴクリック時のリダイレクト問題**
   - 問題: ログイン後にヘッダーの Logbook ロゴをクリックすると `/setup` にリダイレクトしてしまう
   - 原因: `RequireUsername` ガードが過剰に適用されていた
   - 対応: ガードを削除し、認証コールバックで `/setup` に直接リダイレクトするシンプルな設計に変更

2. **公開タイムラインでのアバター画像表示**
   - 問題: 左上のユーザーアイコンに登録したアバター画像が表示されていない
   - 対応: REQ-7 にアバター表示の要件を追加

3. **Google名の表示問題**
   - 問題: サイト内で Google アカウントに紐づいた名前が表示されている
   - 期待: ハンドルネームのみを表示し、Google名は非表示
   - 対応: REQ-8 を新規追加

4. **用語の統一**
   - 問題: 「ユーザー名」と「ハンドルネーム」が混在
   - 対応: UI表示はすべて「ハンドルネーム」に統一

5. **アカウント設定内の表記重複**
   - 問題: 「ユーザー名」と2回表記されている
   - 対応: REQ-5 にタイトルのみ表示の要件を追加

### Improvement Suggestions

- アバター未設定時のデフォルトアイコンはイニシャル表示が望ましい
- Googleアカウントの画像は一切使用しない方針に変更